# Implementation Plan

- [ ] 1. プロジェクト基盤の構築
  - Cargo.tomlの作成とクレート依存関係の設定（clap, ratatui, serde, toml, notify等）
  - 基本的なプロジェクト構造とモジュール定義の実装
  - _Requirements: 1.1, 4.4, 5.1, 6.1_

- [x] 2. コア型定義とエラーハンドリング
  - [x] 2.1 基本データ型とエラー型の定義
    - AgentEnvironment、Config、SymlinkInfo等の構造体を定義
    - 包括的なカスタムエラー型（GitError, SymlinkError, ConfigError等）を実装
    - 部分的失敗時の状態管理用の型を追加
    - _Requirements: 1.1, 2.1, 2.4_

  - [x] 2.2 設定システムの実装
    - TOML設定ファイルの読み込み・書き込み機能を実装
    - シンボリックリンク設定の定義機能（source/target ペア）を実装
    - フック機能の設定（pre_create, post_create, pre_remove, post_remove）を実装
    - デフォルト設定とバリデーション機能を追加
    - グローバル設定とプロジェクト設定の優先順位処理を実装
    - 設定ファイル初期化コマンド（`twin init`）を実装
    - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 3. 環境状態管理システムの実装
  - [ ] 3.1 環境レジストリの実装
    - 作成済み環境の永続化機能（JSON/TOML形式）を実装
    - 環境一覧の取得・更新・削除機能を追加
    - 環境状態の整合性チェック機能を実装
    - _Requirements: 1.1, 5.3_

  - [ ] 3.2 並行実行制御の実装
    - ファイルベースのロック機能（.git/twin.lock）を実装
    - ロック取得・解放・タイムアウト処理を追加
    - プロセス終了時の自動ロック解放機能を実装
    - 並行実行検出とエラーハンドリングを追加
    - _Requirements: 4.4_

  - [ ] 3.2 透明性のあるコマンド実行システム
    - Gitコマンド実行時のログ表示機能を実装
    - シンボリックリンク操作の詳細表示機能を追加
    - ユーザー確認プロンプト機能を実装
    - _Requirements: 4.1, 4.2, 4.3_

- [x] 4. Git Worktree管理機能の実装
  - [x] 4.1 Worktree操作の基本機能
    - git worktree add/remove コマンドのラッパー関数を実装
    - worktree一覧取得とパース機能を追加
    - Git操作失敗時の復旧処理とエラーハンドリングを実装
    - _Requirements: 1.1, 1.2, 1.3_

  - [x] 4.2 ブランチ管理機能
    - 新しいブランチの自動作成機能を実装
    - エージェント名を含むブランチ命名規則を適用
    - ブランチ作成失敗時の代替名生成機能を追加
    - _Requirements: 1.2_

  - [x] 4.3 ディレクトリ移動支援機能
    - パス出力とcdコマンド文字列生成機能を実装
    - `--print-path`と`--cd-command`オプションの実装
    - シェル関数/エイリアス用のヘルパー機能を追加
    - _Requirements: 1.3, 1.4_

- [x] 5. クロスプラットフォームシンボリックリンク管理
  - [x] 5.1 プラットフォーム検出とトレイト定義
    - SymlinkManagerトレイトを定義
    - Unix/Windows用の実装構造体を作成
    - プラットフォーム固有のエラーハンドリングを実装
    - _Requirements: 2.2, 2.3_

  - [x] 5.2 シンボリックリンク操作の実装
    - Unix用のln -sラッパーを実装
    - Windows用のmklinkラッパーを実装
    - リンク作成・削除・検証機能を追加
    - 手動リンク作成方法の提示機能を実装
    - _Requirements: 2.1, 2.4, 2.5_

- [x] 6. フック実行システムの実装
  - [x] 6.1 コマンドフック実行機能
    - pre_create/post_create/pre_remove/post_remove フックの実行機能を実装
    - フック実行時のエラーハンドリングと継続/中断制御を追加
    - フック実行ログの表示機能を実装
    - _Requirements: 6.1, 4.1_

- [ ] 7. 環境管理コア機能の実装
  - [ ] 7.1 EnvironmentManagerの実装
    - 環境作成・削除・一覧・切り替え機能を実装
    - worktreeとシンボリックリンクの統合管理
    - フック機能との統合（作成・削除時のフック実行）
    - 部分的失敗時のロールバック機能を追加
    - _Requirements: 1.1, 1.3, 1.4_

  - [ ] 7.2 自動コミット機能の実装（オプション）
    - notify crateを使用したファイル変更監視を実装
    - 意味のあるコミットメッセージ生成機能を実装
    - 定期的な自動コミット実行機能を追加
    - 手動コミット検出と自動コミット一時停止機能を実装
    - 環境削除時の最終コミット機能を追加
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [-] 8. CLI インターフェースの実装
  - [ ] 7.1 基本CLIコマンドの実装
    - clap を使用したコマンドライン引数パースを実装
    - create/list/remove/switch/init サブコマンドを追加
    - 設定ファイル管理コマンド（init, config）を実装
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 6.1_

  - [ ] 7.2 出力フォーマット機能
    - テーブル・JSON・シンプル形式の出力を実装
    - 透明性のあるコマンド実行ログ表示を追加
    - _Requirements: 4.1, 4.2, 4.3_

- [ ] 8. TUI インターフェースの実装
  - [ ] 8.1 基本TUI構造の実装
    - ratatui を使用した基本的なTUIアプリケーション構造を作成
    - 環境一覧表示とキーボード操作を実装
    - _Requirements: 4.1, 4.2, 4.3_

  - [ ] 8.2 TUI操作機能の実装
    - 環境作成・削除・切り替えのTUI操作を実装
    - エラー表示とユーザーフィードバック機能を追加
    - _Requirements: 4.3, 4.4_

- [ ] 9. テストの実装
  - [ ] 9.1 ユニットテストの作成
    - 各モジュールの単体テストを実装
    - モック機能を使用したGitコマンドテストを追加
    - _Requirements: 全要件のテストカバレッジ_

  - [ ] 9.2 統合テストの作成
    - エンドツーエンドの環境作成・削除フローをテスト
    - クロスプラットフォーム動作の検証テストを実装
    - _Requirements: 全要件の統合テスト_

- [ ] 10. ドキュメントとビルド設定
  - [ ] 10.1 ドキュメント作成
    - README.mdとCLIヘルプメッセージを作成
    - 設定ファイルの例とトラブルシューティングガイドを追加
    - シェル統合の使用例（関数/エイリアス）を追加
    - _Requirements: 6.3, 6.4_

  - [ ] 10.2 リリース準備
    - GitHub Actions等のCI/CD設定を追加
    - クロスプラットフォームビルドとリリース自動化を実装
    - _Requirements: 4.4, 5.1, 5.2, 5.3, 5.4_