#!/bin/sh
set -e

echo "ğŸš€ Running pre-push checks..."
echo ""

# 1. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Verifying code formatting..."
if ! cargo fmt -- --check; then
    echo ""
    echo "âŒ Code is not properly formatted!"
    echo "ğŸ’¡ Run 'cargo fmt' before pushing"
    exit 1
fi
echo "âœ… Format check passed"
echo ""

# 2. Clippy
echo "ğŸ” Running comprehensive clippy analysis..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo ""
    echo "âŒ Clippy found issues that must be fixed!"
    exit 1
fi
echo "âœ… Clippy check passed"
echo ""

# 3. ãƒ“ãƒ«ãƒ‰ï¼ˆãƒªãƒªãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼‰
echo "ğŸ”¨ Building in release mode..."
if ! cargo build --release; then
    echo ""
    echo "âŒ Release build failed!"
    exit 1
fi
echo "âœ… Release build successful"
echo ""

# 4. å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (nextest)
echo "ğŸ§ª Running all tests with nextest..."
if command -v cargo-nextest >/dev/null 2>&1; then
    # nextestã§å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    if ! cargo nextest run --all-targets --all-features; then
        echo ""
        echo "âŒ Some tests failed!"
        exit 1
    fi
    echo "âœ… All tests passed (nextest)"
else
    # nextestãŒãªã„å ´åˆã¯é€šå¸¸ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    echo "âš ï¸  cargo-nextest not found, using standard test runner"
    if ! cargo test --all-targets --all-features; then
        echo ""
        echo "âŒ Some tests failed!"
        exit 1
    fi
    echo "âœ… All tests passed (standard runner)"
fi
echo ""

# 5. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
echo "ğŸ“š Running documentation tests..."
# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ†ã‚¹ãƒˆã¯æ¨™æº–ã®cargo testã§å®Ÿè¡Œï¼ˆnextestã¯æœªå¯¾å¿œï¼‰
if ! cargo test --doc; then
    echo ""
    echo "âŒ Documentation tests failed!"
    exit 1
fi
echo "âœ… Documentation tests passed"
echo ""

# 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆcargo-auditãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
if command -v cargo-audit >/dev/null 2>&1; then
    echo "ğŸ”’ Running security audit..."
    if ! cargo audit; then
        echo ""
        echo "âš ï¸  Security vulnerabilities detected!"
        echo "ğŸ’¡ Run 'cargo audit fix' or update dependencies"
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã¯è­¦å‘Šã®ã¿ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
    else
        echo "âœ… No security vulnerabilities found"
    fi
    echo ""
fi

echo "âœ¨ All pre-push checks completed successfully!"
echo "ğŸ¯ Ready to push to remote repository"