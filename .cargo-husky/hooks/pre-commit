#!/bin/sh
set -e

echo "ğŸš€ Running pre-commit checks..."
echo ""

# 1. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Checking code formatting..."
if ! cargo fmt -- --check; then
    echo ""
    echo "âŒ Code is not properly formatted!"
    echo "ğŸ’¡ Run 'cargo fmt' to fix formatting issues"
    exit 1
fi
echo "âœ… Format check passed"
echo ""

# 2. Clippy (Linter) - warningsã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
echo "ğŸ” Running clippy linter..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo ""
    echo "âŒ Clippy found issues!"
    echo "ğŸ’¡ Fix the warnings above before committing"
    exit 1
fi
echo "âœ… Clippy check passed"
echo ""

# 3. ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
echo "ğŸ”¨ Checking if project builds..."
if ! cargo check --all-targets; then
    echo ""
    echo "âŒ Build check failed!"
    exit 1
fi
echo "âœ… Build check passed"
echo ""

# 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (nextest)
echo "ğŸ§ª Running tests with nextest..."
if command -v cargo-nextest >/dev/null 2>&1; then
    # nextestãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆ
    if ! cargo nextest run; then
        echo ""
        echo "âŒ Some tests failed!"
        exit 1
    fi
else
    # nextestãŒãªã„å ´åˆã¯é€šå¸¸ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    echo "âš ï¸  cargo-nextest not found, falling back to standard test runner"
    echo "ğŸ’¡ Install nextest with: cargo install cargo-nextest --locked"
    if ! cargo test; then
        echo ""
        echo "âŒ Some tests failed!"
        exit 1
    fi
fi
echo "âœ… Tests passed"
echo ""

echo "âœ¨ All pre-commit checks passed successfully!"